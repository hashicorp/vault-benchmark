---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-benchmark

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-benchmark-configmap
data:
  k8s_config.json: |
    {
      "kubernetes_host":"https://kubernetes.default.svc"
    }
  k8s_role_config.json: |
    {
      "name":"vault-benchmark-role",
      "bound_service_account_names":["vault-benchmark"],
      "bound_service_account_namespaces":["*"],
      "token_max_ttl":"24h",
      "token_ttl":"1h"
    }

---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-benchmark
spec:
  backoffLimit: 0
  template:
    metadata:
      name: vault-benchmark
      labels:
        app: vault-benchmark
    spec:
      containers:
      - name: vault-benchmark
        image: hashicorp/vault-benchmark:latest
        imagePullPolicy: IfNotPresent
        command: ["vault-benchmark"]
        args: [
          "-vault_addr=http://vault:8200",
          "-vault_token=root",
          "-pct_k8s_login=100",
          "-k8s_config_json=/config/k8s_config.json",
          "-k8s_role_config_json=/config/k8s_role_config.json"
          ]
        volumeMounts:
        - name: benchmark-config
          mountPath: "/config"
          readOnly: true
      restartPolicy: Never
      serviceAccountName: vault-benchmark
      volumes:
      - name: benchmark-config
        configMap:
          name: vault-benchmark-configmap
